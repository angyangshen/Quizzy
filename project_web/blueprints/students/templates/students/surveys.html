{% assets "home_css" %}
<link rel="stylesheet" href="{{ ASSET_URL }}" />
{% endassets %} {% assets "home_js" %}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
{% endassets %}

<h1>Welcome to the {{survey.topic}} survey !</h1>

<form class="student_survey">
  {% for survey_pair in survey.question_answer %}{% if
  survey_pair['type']=="normal" %}
  <div class="student_pair">
    <div class="student_question">{{survey_pair['question']}}</div>
    <div class="question_type" style="display: none;">normal</div>
    <input name="student_answer_normal" class="form-control student_answer_normal" />
  </div>

  {% elif survey_pair['type']=="mcq" %}
  <div class="student_pair">
    <div class="student_question">{{survey_pair['question']}}</div>
    <div class="question_type" style="display: none;">mcq</div>
    <form name="student_answer" class="student_answer">
        <input type="radio" class="mcquestion" name="mcquestion" value="{{survey_pair['choice'][0]}}"
          >{{survey_pair['choice'][0]}}</input><br />
        <input type="radio" class="mcquestion" name="mcquestion" value="{{survey_pair['choice'][1]}}"
          >{{survey_pair['choice'][1]}}</input><br />
        <input type="radio" class="mcquestion" name="mcquestion" value="{{survey_pair['choice'][2]}}"
          >{{survey_pair['choice'][2]}}</input><br />
        <input type="radio" class="mcquestion" name="mcquestion" value="{{survey_pair['choice'][3]}}"
          >{{survey_pair['choice'][3]}}</input><br />
    </form>

  </div>
  {% endif %}{% endfor %}
  <button
    href="surveys/result"
    type="button"
    onclick="checkAnswer()"
    class="btn btn-primary"
  >
    Submit survey
  </button>
</form>

<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"
></script>
<script>
  let mcquestion = document.getElementsByClassName("mcquestion");
  student_survey = document.getElementsByClassName("student_survey");
  student_pair = document.getElementsByClassName("student_pair");
  
  function checkAnswer() {
    data = [];
    for (let i = 0; i < student_pair.length; i++) {
      let pair = student_pair[i];
      question_types = student_pair[i].getElementsByClassName("question_type")[0].innerText;
      if (question_types == "mcq"){
        for (let j = 0; j < mcquestion.length; j++){
          if(mcquestion[j].checked){
            student_answer = mcquestion[j].value;
            break;
          }
        }
      }
      else {
        student_answer = pair.getElementsByClassName("student_answer_normal")[0].value;
      }
      student_question = pair.getElementsByClassName("student_question")[0]
        .innerText;
      question_type = pair.getElementsByClassName("question_type")[0].innerText;
      data.push({
        type: question_type,
        question: student_question,
        answer: student_answer
      });
    }
    $.ajax({
      type: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      url: "{{ url_for('surveys.checkAnswer')}}",
      data: JSON.stringify({
        id: "{{survey.id}}",
        survey: data
      }),
      success: response => {
        window.location.replace(response);
      }
    });
  }
</script>
